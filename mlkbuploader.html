<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malay Language Adventure</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .font-baloo { font-family: 'Baloo 2', cursive; }
    .level-card { transition: all 0.2s ease-in-out; }
    .level-card.locked { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .level-card:not(.locked):hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .challenge-completed { opacity: 0.7; background: #d1fae5; cursor: not-allowed; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
  </style>
</head>
<body class="bg-blue-50 text-gray-800">

  <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6">
    <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
      <h1 class="text-2xl md:text-3xl font-baloo text-blue-600">Selamat Datang!</h1>
      <div id="user-profile" class="text-right">
        <div class="font-semibold text-lg" id="user-name-display">Murid</div>
        <div class="text-sm text-yellow-500"><span id="user-points">0</span> points âœ¨</div>
      </div>
    </header>

    <main id="main-content">
      <!-- DASHBOARD SCREEN -->
      <div id="dashboard-screen">
         <div id="learner-dashboard">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow text-center">
                  <h3 class="font-semibold text-gray-500">Pangkat</h3>
                  <p id="user-rank" class="text-2xl font-baloo text-blue-500">Baru</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                  <h3 class="font-semibold text-gray-500">Lencana</h3>
                  <div id="badges-display" class="flex justify-center items-center space-x-2 mt-2">
                    <span class="text-gray-400">Tiada lagi</span>
                  </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                  <h3 class="font-semibold text-gray-500">Tokens</h3>
                  <p id="user-tokens" class="text-2xl font-baloo text-purple-500">0 ðŸª™</p>
                </div>
            </div>
            <div id="daily-word-container" class="mb-6">
                <h2 class="text-2xl font-baloo mb-4">Kata Hari Ini (Word of the Day)</h2>
                <div id="daily-word-card" class="bg-green-200 p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-green-400">
                    <h3 class="text-xl font-baloo text-green-800"></h3>
                    <p class="text-green-700 mt-2"></p>
                </div>
            </div>
            <div id="module-selection">
                <h2 class="text-2xl font-baloo mb-4">Pilih Modul (Choose a Module)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="module-imbuhan" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                      <h3 class="text-xl font-baloo text-teal-600">Imbuhan</h3>
                      <p class="text-gray-600 mt-2">Kuasai seni imbuhan Melayu.</p>
                    </div>
                    <div id="module-peribahasa" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                      <h3 class="text-xl font-baloo text-indigo-600">Peribahasa</h3>
                      <p class="text-gray-600 mt-2">Pelajari peribahasa untuk bahasa yang indah.</p>
                    </div>
                </div>
            </div>
         </div>
      </div>
      
      <div id="level-selection-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
      <div id="quiz-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
    </main>
  </div>
  
  <div id="achievement-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-xl w-64">
    <p class="font-bold">Lencana Baru!</p>
    <p id="achievement-name"></p>
  </div>

  <script type="module">
    // --- In-App Knowledge Base (from your documents) ---
    const knowledgeBase = {
      imbuhan: {
        beginner: "Awalan 'meN-' menjadi 'meng-' apabila bertemu kata dasar bermula dengan huruf g, h, dan vokal (a, e, i, o, u). Contoh: menggali.",
        intermediate: "Imbuhan apitan 'ke-...-an' membentuk kata nama abstrak yang merujuk kepada hal atau keadaan. Contoh: baik -> kebaikan.",
        advanced: "Akhiran '-kan' dan '-i' kedua-duanya membentuk kata kerja transitif. Contoh: 'Saya hadiahkan buku ini kepadanya'."
      },
      peribahasa: {
        beginner: "Peribahasa 'bagai aur dengan tebing' bermaksud hubungan yang sangat rapat dan saling membantu. 'Anak emas' bermaksud orang yang sangat disayangi.",
        intermediate: "'Berat sama dipikul, ringan sama dijinjing' bermaksud bekerjasama dalam melakukan sesuatu kerja.",
        advanced: "'Mencurah air ke daun keladi' bermaksud memberi nasihat yang sia-sia atau tidak dihargai."
      }
    };

    // --- DOM Elements ---
    const allScreens = ['dashboard-screen','level-selection-screen','quiz-screen'];
    
    // --- User Data ---
    let userData = {};
    let currentProfile = null; // assume you set this on login

    // â”€â”€â”€ NEW: n8n webhook constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const N8N_BASE = 'https://harmanjohll.app.n8n.cloud';
    const START_QUIZ_URL = `${N8N_BASE}/webhook/start-quiz`;
    // (Use `/webhook-test/start-quiz` if you want the test endpoint)

    // --- Main App Logic ---
    function main() {
      loadOrCreateUser();
      showDashboard();
    }

    // --- User & Auth Functions ---
    function loadOrCreateUser() {
      // your existing localStorage logic...
      // userData = { name:'Murid', points:0, tokens:0, rank:'Baru', badges:[], unlockedLevels:{ imbuhan:['beginner'], peribahasa:['beginner'] }, lastWordDate:null };
      saveUserData();
    }
    function saveUserData() {
      localStorage.setItem('malayAdventureUserData', JSON.stringify(userData));
    }

    function updateUI() {
      document.getElementById('user-name-display').textContent = userData.name;
      document.getElementById('user-points').textContent = userData.points;
      document.getElementById('user-tokens').textContent = `${userData.tokens} ðŸª™`;
      document.getElementById('user-rank').textContent = userData.rank;
      // badges & word-of-the-day logic...
    }

    // --- Daily Word Logic ---
    // ... your existing wordsOfTheDay and setupWordOfTheDay functions ...

    // --- Navigation ---
    function showView(viewName) {
      allScreens.forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(viewName).classList.remove('hidden');
    }
    function showDashboard() {
      updateUI();
      showView('dashboard-screen');
    }

    function openLevelSelection(moduleKey) {
      // your existing level-selection rendering...
      showView('level-selection-screen');
    }

    // â”€â”€â”€ UPDATED: Quiz Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startGeneratedQuiz(moduleKey, levelKey) {
      const quizScreen = document.getElementById('quiz-screen');
      quizScreen.innerHTML = `<div class="loader"></div><h2 class="text-2xl font-baloo text-center">Menjana Kuizâ€¦</h2><p class="text-center">Sila tunggu sebentar.</p>`;
      showView('quiz-screen');
      
      try {
        const response = await fetch(START_QUIZ_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profileId: currentProfile?.id || '',   // ensure you set this on login
            module: moduleKey,
            level: levelKey,
            contextSnippet: knowledgeBase[moduleKey][levelKey],
            history: []  // empty for first call
          })
        });
        if (!response.ok) throw new Error(`API error ${response.status}`);
        const { questions } = await response.json();
        loadQuiz(questions, moduleKey, levelKey);
      } catch (err) {
        quizScreen.innerHTML = `<div class="text-red-500 text-center"><b>Gagal:</b> ${err.message}</div><button onclick="showDashboard()" class="mt-4 bg-gray-300 px-4 py-2 rounded">Kembali</button>`;
      }
    }

    function constructPrompt(moduleKey, levelKey) {
      // no longer used
    }

    function loadQuiz(questions, moduleKey, levelKey) {
      // your existing loadQuiz logic unchanged...
    }

    // --- Initialize App ---
    main();
    document.querySelectorAll('.module-card').forEach(card => {
      card.onclick = () => openLevelSelection(card.id.split('-')[1]);
    });
  </script>
</body>
</html>
