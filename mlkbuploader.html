<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malay Language Adventure</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&
family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* your original styles… */
  </style>
</head>
<body class="bg-blue-50 text-gray-800">

  <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6">

    <!-- ➊ LOGIN / PROFILE SELECTION SCREEN (RESTORED) -->
    <div id="login-screen" class="bg-white p-8 rounded-xl shadow-md">
      <h2 class="text-2xl font-baloo mb-4">Pilih Akaun (Select Profile)</h2>
      <div id="profiles-list" class="space-y-2"></div>
      <div class="mt-6">
        <input id="new-username" type="text" placeholder="Nama baru" class="p-2 border rounded" />
        <button id="create-profile-btn" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded">Cipta Akaun</button>
      </div>
    </div>

    <!-- DASHBOARD, MODULE, QUIZ etc… all your original screens untouched -->
    <div id="dashboard-screen" class="hidden">
      <!-- … your entire dashboard HTML … -->
    </div>
    <div id="level-selection-screen" class="hidden">…</div>
    <div id="quiz-screen" class="hidden">…</div>

  </div>

  <div id="achievement-notification" class="hidden">…</div>

  <script type="module">
    // ─── SUPABASE CLIENT (for profiles) ─────────────────────────────────────────
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://qvowmphqmflfanjospqm.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
    const supa = createClient(supabaseUrl, supabaseKey);

    // ─── n8n WEBHOOK ─────────────────────────────────────────────────────────────
    const N8N_BASE = 'https://harmanjohll.app.n8n.cloud';
    const START_QUIZ_URL = `${N8N_BASE}/webhook/start-quiz`;
    // (use /webhook-test/start-quiz while you’re still tweaking)

    // ─── GLOBAL STATE ────────────────────────────────────────────────────────────
    let currentProfile = null;         // ➋ will hold the logged‐in profile
    let userData = {};                 // your existing points/tokens/etc

    // ─── 1) LOAD OR CREATE PROFILES ─────────────────────────────────────────────
    async function loadProfiles() {
      const { data, error } = await supa.from('profiles').select('*').order('created_at');
      const list = document.getElementById('profiles-list');
      list.innerHTML = '';
      data.forEach(p => {
        const btn = document.createElement('button');
        btn.textContent = p.username;
        btn.className = 'block w-full text-left p-4 bg-white rounded-xl shadow mb-2';
        btn.onclick = () => {
          currentProfile = p;
          loadOrCreateUserData();
          showDashboard();
        };
        list.appendChild(btn);
      });
      document.getElementById('create-profile-btn').onclick = async () => {
        const name = document.getElementById('new-username').value.trim();
        if (!name) return;
        const { data:[newP] } = await supa.from('profiles').insert({ username:name }).select().single();
        currentProfile = newP;
        loadOrCreateUserData();
        showDashboard();
      };
    }

    function loadOrCreateUserData() {
      // your localStorage logic for userData…
      // e.g. const saved = localStorage.getItem(`mla_${currentProfile.id}`) …
    }

    function saveUserData() {
      // localStorage.setItem ...
    }

    // ─── 2) SHOW / HIDE SCREENS ─────────────────────────────────────────────────
    const allScreens = ['login-screen','dashboard-screen','level-selection-screen','quiz-screen'];
    function showView(id){
      allScreens.forEach(s=>document.getElementById(s).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function showDashboard(){
      // update your points/tokens/rank UI…
      showView('dashboard-screen');
    }

    // ─── 3) YOUR EXISTING KB, DAILY WORD, MODULE SELECTION, QUIZ FLOW …──────────
    // copy/paste your entire knowledgeBase, wordsOfTheDay, moduleData,
    // main(), setupWordOfTheDay(), openLevelSelection(), constructPrompt(), loadQuiz(), etc.
    // **None of that changes.**

    // ─── 4) UPDATED: startGeneratedQuiz ➔ CALL n8n INSTEAD OF Gemini/Make ──
    async function startGeneratedQuiz(moduleKey, levelKey) {
      const quizScreen = document.getElementById('quiz-screen');
      quizScreen.innerHTML = `<div class="loader"></div><h2 class="text-2xl font-baloo text-center">Menjana Kuiz…</h2>`;
      showView('quiz-screen');

      try {
        const res = await fetch(START_QUIZ_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            profileId: currentProfile.id,               // ➋ send who’s learning
            module: moduleKey,
            level: levelKey,
            contextSnippet: knowledgeBase[moduleKey][levelKey],
            history: []
          })
        });
        if (!res.ok) throw new Error(`API error ${res.status}`);
        const { questions } = await res.json();
        loadQuiz(questions, moduleKey, levelKey);
      } catch(err) {
        quizScreen.innerHTML = `
          <div class="text-red-500 text-center">Gagal: ${err.message}</div>
          <button onclick="openLevelSelection('${moduleKey}')" class="mt-4 bg-gray-300 py-2 px-4 rounded">Kembali</button>`;
      }
    }

    // ─── 5) INITIALIZE APP ──────────────────────────────────────────────────────
    window.onload = loadProfiles;       // start on the login screen
    // your existing code also hooks up .module-card clicks, etc.

  </script>
</body>
</html>
