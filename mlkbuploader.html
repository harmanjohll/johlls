<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Malay Language Adventure (Debug Mode)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .font-baloo { font-family: 'Baloo 2', cursive; }
    .level-card { transition: all 0.2s ease-in-out; }
    .level-card.locked { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .level-card:not(.locked):hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .challenge-completed { opacity: 0.7; background: #d1fae5; cursor: not-allowed; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
  </style>
</head>
<body class="bg-blue-50 text-gray-800">

  <!-- TEST HEADING: should appear in red at top of page -->
  <h1 id="test-heading" style="color:red; font-size:2rem; text-align:center; margin-top:1rem;">
    HELLOâ€”PAGE LOADED
  </h1>

  <!-- INLINE SCRIPT: should log to console -->
  <script>
    console.log("ğŸ’¡ Inline script ran!");
  </script>

  <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6">

    <!-- LOGIN / PROFILE SCREEN -->
    <div id="login-screen" class="bg-white p-8 rounded-xl shadow-md">
      <h2 class="text-2xl font-baloo mb-4">Pilih Akaun (Select Profile)</h2>
      <div id="profiles-list" class="space-y-2"></div>
      <div class="mt-6">
        <input id="new-username" type="text" placeholder="Nama baru" class="p-2 border rounded" />
        <button id="create-profile-btn" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded">Cipta Akaun</button>
      </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
      <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
        <h1 class="text-2xl md:text-3xl font-baloo text-blue-600">Selamat Datang!</h1>
        <div id="user-profile" class="text-right">
          <div class="font-semibold text-lg" id="user-name-display">Murid</div>
          <div class="text-sm text-yellow-500"><span id="user-points">0</span> points âœ¨</div>
        </div>
      </header>
      <main>
        <div id="learner-dashboard">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Pangkat</h3>
              <p id="user-rank" class="text-2xl font-baloo text-blue-500">Baru</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Lencana</h3>
              <div id="badges-display" class="flex justify-center items-center space-x-2 mt-2">
                <span class="text-gray-400">Tiada lagi</span>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Tokens</h3>
              <p id="user-tokens" class="text-2xl font-baloo text-purple-500">0 ğŸª™</p>
            </div>
          </div>

          <div id="daily-word-container" class="mb-6">
            <h2 class="text-2xl font-baloo mb-4">Kata Hari Ini (Word of the Day)</h2>
            <div id="daily-word-card" class="bg-green-200 p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-green-400">
              <h3 class="text-xl font-baloo text-green-800"></h3>
              <p class="text-green-700 mt-2"></p>
            </div>
          </div>

          <div id="module-selection">
            <h2 class="text-2xl font-baloo mb-4">Pilih Modul (Choose a Module)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div id="module-imbuhan" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <h3 class="text-xl font-baloo text-teal-600">Imbuhan</h3>
                <p class="text-gray-600 mt-2">Kuasai seni imbuhan Melayu.</p>
              </div>
              <div id="module-peribahasa" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <h3 class="text-xl font-baloo text-indigo-600">Peribahasa</h3>
                <p class="text-gray-600 mt-2">(Placeholder)</p>
              </div>
            </div>
          </div>
        </div>

        <div id="level-selection-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
        <div id="quiz-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
      </main>
    </div>
  </div>

  <div id="achievement-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-xl w-64">
    <p class="font-bold">Lencana Baru!</p>
    <p id="achievement-name"></p>
  </div>

  <script type="module">
    // â”€â”€â”€ (1) Supabase Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://qvowmphqmflfanjospqm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2b3dtcGhxbWZsZmFuam9zcHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTY3NTksImV4cCI6MjA2ODAzMjc1OX0.-AdJqEXD8N5C4iNQH3W3s6e1swVompOMQh0rTj3gXQk';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // â”€â”€â”€ (2) Static KB Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const KB_URL = 'https://harmanjohll.github.io/learnmalay/Imbuhan_KB.md';
    let imbuhanKB = '';
    fetch(KB_URL)
      .then(r => r.text())
      .then(txt => {
        imbuhanKB = txt;
        console.log('âœ… Imbuhan KB loaded:', imbuhanKB.slice(0,50) + 'â€¦');
      })
      .catch(err => console.error('âŒ KB load failed:', err));

    // â”€â”€â”€ (3) In-App Data & KB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const knowledgeBase = {
      imbuhan: { beginner: () => imbuhanKB },
      peribahasa: { beginner: () => '(KB placeholder)' }
    };
    const moduleData = {
      imbuhan: { name: 'Imbuhan', levels: ['beginner'] },
      peribahasa: { name: 'Peribahasa', levels: ['beginner'] }
    };
    const wordsOfTheDay = [
      { word:'Cekal', meaning:'Resilient', sentence:'Kita mesti ______ â€¦', options:['cekap','cekal','cekik'] },
      { word:'Muafakat', meaning:'Consensus', sentence:'Hasil ______ semua ahli â€¦', options:['muafakat','mufakat','muflis'] }
    ];
    const allScreens = ['login-screen','dashboard-screen','level-selection-screen','quiz-screen'];
    let currentProfile = null, userData = {};

    // â”€â”€â”€ (4) onDOMContentLoaded: bind everything â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”§ DOMContentLoaded â€” initializing app');
      loadProfiles();
      document.querySelectorAll('.module-card').forEach(card => {
        card.addEventListener('click', () => {
          console.log('â–¶ Module clicked:', card.id);
          openLevelSelection(card.id.split('-')[1]);
        });
      });
    });

    // â”€â”€â”€ Profile / Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadProfiles() {
      console.log('â³ loadProfiles()');
      showView('login-screen');
      const { data:profiles, error } = await supabase.from('profiles').select('*').order('created_at');
      if (error) return console.error('âŒ loadProfiles error', error);
      const list = document.getElementById('profiles-list');
      list.innerHTML = '';
      profiles.forEach(p => {
        const btn = document.createElement('button');
        btn.textContent = p.username;
        btn.className = 'block w-full p-4 bg-white rounded-xl shadow mb-2';
        btn.onclick = () => {
          console.log('â–¶ Profile selected:', p);
          currentProfile = p;
          loadOrCreateUser();
          showDashboard();
        };
        list.appendChild(btn);
      });
      document.getElementById('create-profile-btn').onclick = async () => {
        const name = document.getElementById('new-username').value.trim();
        if (!name) return;
        console.log('â• Creating new profile:', name);
        const { data:newP, error:ie } = await supabase.from('profiles').insert({ username:name }).select().single();
        if (ie) return console.error('âŒ insert profile', ie);
        currentProfile = newP;
        loadOrCreateUser();
        showDashboard();
      };
    }

    function loadOrCreateUser() {
      console.log('â³ loadOrCreateUser()', currentProfile);
      const key = `mla_${currentProfile.id}`;
      const saved = localStorage.getItem(key);
      if (saved) {
        userData = JSON.parse(saved);
        console.log('âš™ Loaded userData from localStorage', userData);
      } else {
        userData = {
          name: currentProfile.username,
          points: 0,
          tokens: 0,
          rank: 'Baru',
          badges: [],
          unlockedLevels: { imbuhan:['beginner'], peribahasa:['beginner'] },
          lastWordDate: null
        };
        localStorage.setItem(key, JSON.stringify(userData));
        console.log('âš™ Initialized new userData', userData);
      }
    }
    function saveUserData() {
      const key = `mla_${currentProfile.id}`;
      localStorage.setItem(key, JSON.stringify(userData));
      console.log('ğŸ’¾ userData saved', userData);
    }

    // â”€â”€â”€ UI Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showView(id) {
      allScreens.forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      console.log('ğŸŒ showView()', id);
    }
    function showDashboard() {
      console.log('ğŸŒ showDashboard()');
      document.getElementById('user-name-display').textContent = currentProfile.username;
      document.getElementById('user-points').textContent = userData.points;
      document.getElementById('user-tokens').textContent = `${userData.tokens} ğŸª™`;
      document.getElementById('user-rank').textContent = userData.rank;
      setupWordOfTheDay();
      showView('dashboard-screen');
    }

    // â”€â”€â”€ Word of the Day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setupWordOfTheDay() {
      console.log('â³ setupWordOfTheDay()');
      const today = new Date().toISOString().split('T')[0];
      const idx = new Date(today).getDate() % wordsOfTheDay.length;
      const wd = wordsOfTheDay[idx];
      const card = document.getElementById('daily-word-card');
      const h3 = card.querySelector('h3'), p = card.querySelector('p');
      // Remove old listeners if any
      card.replaceWith(card.cloneNode(true));
      const newCard = document.getElementById('daily-word-card');
      if (userData.lastWordDate === today) {
        newCard.classList.add('challenge-completed');
        h3.textContent = 'Syabas!';
        p.textContent = 'Anda telah melengkapkan kata hari ini.';
        console.log('ğŸ”’ Word of the day already done');
      } else {
        newCard.classList.remove('challenge-completed');
        h3.textContent = `Kata Hari Ini: ${wd.word}`;
        p.textContent = `Maksud: ${wd.meaning}`;
        newCard.addEventListener('click', () => {
          console.log('â–¶ Word-of-the-day clicked:', wd);
          showWordQuiz(wd);
        });
      }
    }

    function showWordQuiz(wd) {
      console.log('â³ showWordQuiz()', wd);
      const qs = document.getElementById('quiz-screen');
      qs.innerHTML = `
        <button onclick="showDashboard()" class="mb-4 bg-gray-300 px-4 py-2 rounded">â† Kembali</button>
        <h2 class="text-3xl font-baloo mb-2">${wd.word}</h2>
        <p class="mb-4">${wd.sentence}</p>
        <div id="opts">${[...wd.options, wd.word].sort(() => Math.random()-0.5).map(o =>
          `<button class="block w-full mb-2 p-4 bg-gray-100 rounded" data-ans="${o}">${o}</button>`
        ).join('')}</div>
        <div id="feedback" class="mt-4"></div>`;
      showView('quiz-screen');
      document.querySelectorAll('#opts button').forEach(b => {
        b.addEventListener('click', e => {
          const sel = e.target.dataset.ans, corr = wd.word;
          console.log('âœï¸ Word answer selected:', sel, 'correct?', corr);
          if (sel === corr) {
            userData.points += 15; userData.lastWordDate = new Date().toISOString().split('T')[0];
            saveUserData();
          }
          document.getElementById('feedback').innerHTML = sel === corr
            ? `<div class="p-4 bg-green-100">Betul! +15 mata</div>`
            : `<div class="p-4 bg-red-100">Betul: ${corr}</div>`;
        });
      });
    }

    // â”€â”€â”€ Module & Level Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openLevelSelection(moduleKey) {
      console.log('â³ openLevelSelection()', moduleKey);
      const mod = moduleData[moduleKey], unlocked = userData.unlockedLevels[moduleKey];
      const scr = document.getElementById('level-selection-screen');
      scr.innerHTML = `
        <button onclick="showDashboard()" class="mb-4 bg-gray-300 px-4 py-2 rounded">â† Kembali</button>
        <h2 class="text-3xl font-baloo mb-4">${mod.name}</h2>`;
      mod.levels.forEach(lk => {
        const isLocked = !unlocked.includes(lk);
        scr.innerHTML += `
          <div id="lvl-${moduleKey}-${lk}" class="level-card p-6 rounded-xl shadow-md ${isLocked?'locked':'cursor-pointer bg-white'}">
            <h3 class="text-xl font-baloo">${lk} ${isLocked?'ğŸ”’':'âœ…'}</h3>
          </div>`;
      });
      showView('level-selection-screen');
      mod.levels.forEach(lk => {
        if (unlocked.includes(lk)) {
          document.getElementById(`lvl-${moduleKey}-${lk}`).addEventListener('click', () => {
            console.log('â–¶ Level selected:', moduleKey, lk);
            startGeneratedQuiz(moduleKey, lk);
          });
        }
      });
    }

    // â”€â”€â”€ Quiz Generation (Gemini) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function constructPrompt(mk, lk) {
      const ctx = knowledgeBase[mk][lk]();
      return `You are an expert Malay educator.\nCONTEXT:\n${ctx}\nGenerate 5 MCQs of difficulty ${lk} on ${moduleData[mk].name}. Return JSON.`;
    }
    async function startGeneratedQuiz(mk, lk) {
      console.log('â³ startGeneratedQuiz()', mk, lk);
      const qs = document.getElementById('quiz-screen');
      qs.innerHTML = `<div class="loader"></div><h2 class="text-2xl font-baloo text-center">Menjana Kuizâ€¦</h2>`;
      showView('quiz-screen');
      try {
        const prompt = constructPrompt(mk, lk);
        console.log('ğŸ“ prompt:', prompt.slice(0,100) + 'â€¦');
        const res = await fetch(
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyC9AKQcORYqndRZGhvTh-OqyMvE-Q7F2aI',
          {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({
              contents:[{ role:'user', parts:[{ text:prompt }] }],
              generationConfig:{ responseMimeType:'application/json' }
            })
          }
        );
        if(!res.ok) throw new Error(`Status ${res.status}`);
        const json = await res.json();
        console.log('âœ… Gemini response:', json);
        const questions = JSON.parse(json.candidates[0].content.parts[0].text).questions;
        loadQuiz(questions, mk, lk);
      } catch(err) {
        console.error('âŒ startGeneratedQuiz error:', err);
        qs.innerHTML = `<div class="text-red-500 text-center">Gagal: ${err.message}</div>
          <button onclick="openLevelSelection('${mk}')" class="mt-4 bg-gray-300 px-4 py-2 rounded">Kembali</button>`;
      }
    }

    // â”€â”€â”€ Quiz UI Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadQuiz(questions, mk, lk) {
      console.log('â³ loadQuiz()', questions);
      let idx = 0, score = 0;
      const qs = document.getElementById('quiz-screen');
      function render() {
        if (idx >= questions.length) {
          console.log('ğŸ Quiz finished, score:', score);
          qs.innerHTML = `<h2 class="text-2xl font-baloo mb-2">Kuiz Selesai!</h2>
            <p class="text-center">Skor anda: ${score}/${questions.length}</p>
            <button onclick="openLevelSelection('${mk}')" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Selesai</button>`;
          return;
        }
        const q = questions[idx];
        qs.innerHTML = `<button onclick="openLevelSelection('${mk}')" class="mb-4 bg-gray-300 px-4 py-2 rounded">â† Kembali</button>
          <h2 class="text-3xl font-baloo mb-2">${moduleData[mk].name} - ${lk}</h2>
          <p class="mb-4">(${idx+1}/${questions.length}) ${q.q}</p>
          <div id="opts">${[...q.o, q.a].sort(()=>0.5-Math.random()).map(opt=>
            `<button class="block w-full mb-2 p-4 bg-gray-100 rounded" data-ans="${opt}">${opt}</button>`
          ).join('')}</div>
          <div id="fb" class="mt-4"></div>
          <button id="nx" class="hidden w-full mt-4 bg-blue-500 text-white py-2 rounded">Seterusnya</button>`;
        document.querySelectorAll('#opts button').forEach(b => {
          b.onclick = e => {
            const sel = e.target.dataset.ans, corr = q.a;
            console.log('âœï¸ Answer:', sel, 'correct?', corr);
            if (sel === corr) {
              score++; userData.points += 10; userData.tokens += 1; saveUserData();
            }
            document.getElementById('fb').innerHTML = sel === corr
              ? `<div class="p-4 bg-green-100">Betul! +10 mata</div>`
              : `<div class="p-4 bg-red-100">Betul: ${corr}</div>`;
            document.getElementById('nx').classList.remove('hidden');
          };
        });
        document.getElementById('nx').onclick = () => { idx++; render(); };
      }
      render();
    }
  </script>
</body>
</html>
