<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Malay Language Adventure</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .font-baloo { font-family: 'Baloo 2', cursive; }
    .level-card { transition: all 0.2s ease-in-out; }
    .level-card.locked { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .level-card:not(.locked):hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .challenge-completed { opacity: 0.7; background: #d1fae5; cursor: not-allowed; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
  </style>
</head>
<body class="bg-blue-50 text-gray-800">

  <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6">

    <!-- LOGIN / PROFILE SELECTION SCREEN -->
    <div id="login-screen" class="bg-white p-8 rounded-xl shadow-md">
      <h2 class="text-2xl font-baloo mb-4">Pilih Akaun (Select Profile)</h2>
      <div id="profiles-list" class="space-y-2"></div>
      <div class="mt-6">
        <input id="new-username" type="text" placeholder="Nama baru" class="p-2 border rounded" />
        <button id="create-profile-btn" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded">Cipta Akaun</button>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="dashboard-screen" class="hidden">
      <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
        <h1 class="text-2xl md:text-3xl font-baloo text-blue-600">Selamat Datang!</h1>
        <div id="user-profile" class="text-right">
          <div class="font-semibold text-lg" id="user-name-display">Murid</div>
          <div class="text-sm text-yellow-500"><span id="user-points">0</span> points ‚ú®</div>
        </div>
      </header>

      <main>
        <div id="learner-dashboard">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Pangkat</h3>
              <p id="user-rank" class="text-2xl font-baloo text-blue-500">Baru</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Lencana</h3>
              <div id="badges-display" class="flex justify-center items-center space-x-2 mt-2">
                <span class="text-gray-400">Tiada lagi</span>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow text-center">
              <h3 class="font-semibold text-gray-500">Tokens</h3>
              <p id="user-tokens" class="text-2xl font-baloo text-purple-500">0 ü™ô</p>
            </div>
          </div>

          <div id="daily-word-container" class="mb-6">
            <h2 class="text-2xl font-baloo mb-4">Kata Hari Ini (Word of the Day)</h2>
            <div id="daily-word-card" class="bg-green-200 p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-green-400">
              <h3 class="text-xl font-baloo text-green-800"></h3>
              <p class="text-green-700 mt-2"></p>
            </div>
          </div>

          <div id="module-selection">
            <h2 class="text-2xl font-baloo mb-4">Pilih Modul (Choose a Module)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div id="module-imbuhan" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <h3 class="text-xl font-baloo text-teal-600">Imbuhan</h3>
                <p class="text-gray-600 mt-2">Kuasai seni imbuhan Melayu.</p>
              </div>
              <div id="module-peribahasa" class="module-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <h3 class="text-xl font-baloo text-indigo-600">Peribahasa</h3>
                <p class="text-gray-600 mt-2">Pelajari peribahasa untuk bahasa yang indah.</p>
              </div>
            </div>
          </div>
        </div>

        <div id="level-selection-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
        <div id="quiz-screen" class="hidden bg-white p-8 rounded-xl shadow-md"></div>
      </main>
    </div>
  </div>

  <div id="achievement-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-xl w-64">
    <p class="font-bold">Lencana Baru!</p>
    <p id="achievement-name"></p>
  </div>

  <script type="module">
    // --- 1) Supabase client setup ---
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://qvowmphqmflfanjospqm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2b3dtcGhxbWZsZmFuam9zcHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTY3NTksImV4cCI6MjA2ODAzMjc1OX0.-AdJqEXD8N5C4iNQH3W3s6e1swVompOMQh0rTj3gXQk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- 2) n8n.webhook constants ---
    const N8N_BASE = 'https://harmanjohll.app.n8n.cloud';
    const START_QUIZ_URL = `${N8N_BASE}/webhook/start-quiz`; // use /webhook-test/start-quiz for testing

    // --- 3) In-App Knowledge Base ---
    const knowledgeBase = {
      imbuhan: {
        beginner: "Awalan 'meN-' menjadi 'meng-' apabila bertemu kata dasar bermula dengan huruf g, h, dan vokal (a, e, i, o, u). Contoh: menggali.",
        intermediate: "Imbuhan apitan 'ke-...-an' membentuk kata nama abstrak. Contoh: kebaikan.",
        advanced: "Perbezaan '-kan' dan '-i' dalam pembentukan kata kerja transitif."
      },
      peribahasa: {
        beginner: "'Bagai aur dengan tebing' bermaksud hubungan sangat rapat. 'Anak emas' bermaksud orang yang sangat disayangi.",
        intermediate: "'Berat sama dipikul, ringan sama dijinjing' bermaksud bekerjasama. 'Seperti katak di bawah tempurung' bermaksud cetek pengetahuan.",
        advanced: "'Mencurah air ke daun keladi' bermaksud memberi nasihat yang sia-sia."
      }
    };

    // --- 4) DOM Elements & App State ---
    const allScreens = ['login-screen','dashboard-screen','level-selection-screen','quiz-screen'];
    let currentProfile = null;
    let userData = {};

    // --- 5) App Initialization ---
    window.onload = () => loadOrCreateProfiles();

    // --- 6) Profile & User Data Functions ---
    async function loadOrCreateProfiles() {
      // show login screen
      showView('login-screen');
      // fetch existing profiles
      const { data: profiles } = await supabase.from('profiles').select('*');
      const list = document.getElementById('profiles-list');
      list.innerHTML = '';
      profiles.forEach(p => {
        const btn = document.createElement('button');
        btn.textContent = p.username;
        btn.className = 'block w-full text-left p-4 bg-white rounded-xl shadow mb-2';
        btn.onclick = () => {
          currentProfile = p;
          loadOrCreateUserData();
          showDashboard();
        };
        list.appendChild(btn);
      });
      document.getElementById('create-profile-btn').onclick = async () => {
        const name = document.getElementById('new-username').value.trim();
        if (!name) return;
        const { data: [newP] } = await supabase
          .from('profiles')
          .insert({ username: name })
          .select()
          .single();
        currentProfile = newP;
        loadOrCreateUserData();
        showDashboard();
      };
    }

    function loadOrCreateUserData() {
      const key = `mla_${currentProfile.id}`;
      const saved = localStorage.getItem(key);
      if (saved) userData = JSON.parse(saved);
      else {
        userData = {
          name: currentProfile.username,
          points: 0,
          tokens: 0,
          rank: 'Baru',
          badges: [],
          unlockedLevels: { imbuhan: ['beginner'], peribahasa: ['beginner'] }
        };
        localStorage.setItem(key, JSON.stringify(userData));
      }
    }

    function saveUserData() {
      localStorage.setItem(`mla_${currentProfile.id}`, JSON.stringify(userData));
    }

    // --- 7) UI Navigation & Updates ---
    function showView(id) {
      allScreens.forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function showDashboard() {
      document.getElementById('user-name-display').textContent = currentProfile.username;
      document.getElementById('user-points').textContent = userData.points;
      document.getElementById('user-tokens').textContent = `${userData.tokens} ü™ô`;
      document.getElementById('user-rank').textContent = userData.rank;
      // badges, daily word, etc. can update here
      showView('dashboard-screen');
    }

    function openLevelSelection(moduleKey) {
      const levels = ['beginner','intermediate','advanced'];
      const unlocked = userData.unlockedLevels[moduleKey];
      const screen = document.getElementById('level-selection-screen');
      screen.innerHTML = `<button id="back">‚Üê Kembali</button><h2 class="text-3xl font-baloo mb-4">${moduleKey}</h2>`;
      levels.forEach(lk => {
        const isLocked = !unlocked.includes(lk);
        const div = document.createElement('div');
        div.id = `lvl-${moduleKey}-${lk}`;
        div.className = `level-card p-6 rounded-xl shadow-md ${isLocked? 'locked':'cursor-pointer bg-white'}`;
        div.textContent = lk;
        screen.appendChild(div);
        if (!isLocked) {
          div.onclick = () => startGeneratedQuiz(moduleKey, lk);
        }
      });
      document.getElementById('back').onclick = showDashboard;
      showView('level-selection-screen');
    }

    // --- 8) Quiz Generation via n8n webhook ---
    async function startGeneratedQuiz(moduleKey, levelKey) {
      const quizScreen = document.getElementById('quiz-screen');
      quizScreen.innerHTML = `<div class="loader"></div><h2 class="text-2xl font-baloo text-center">Menjana Kuiz‚Ä¶</h2>`;
      showView('quiz-screen');
      try {
        const res = await fetch(START_QUIZ_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profileId: currentProfile.id,
            module: moduleKey,
            level: levelKey,
            contextSnippet: knowledgeBase[moduleKey][levelKey],
            history: []
          })
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const { questions } = await res.json();
        loadQuiz(questions, moduleKey, levelKey);
      } catch (err) {
        quizScreen.innerHTML = `
          <p class="text-red-500 text-center">Gagal: ${err.message}</p>
          <button onclick="showDashboard()" class="mt-4 bg-gray-300 text-gray-800 py-2 px-4 rounded">Kembali</button>
        `;
      }
    }

    // --- 9) Quiz UI Rendering & Flow ---
    function loadQuiz(questions, moduleKey, levelKey) {
      let idx = 0, score = 0;
      const quizScreen = document.getElementById('quiz-screen');

      function renderQuestion() {
        if (idx >= questions.length) return finishQuiz();
        const q = questions[idx];
        quizScreen.innerHTML = `
          <button onclick="openLevelSelection('${moduleKey}')" class="mb-4">‚Üê Kembali</button>
          <h2 class="text-3xl font-baloo mb-4">${moduleKey} (${levelKey})</h2>
          <p class="mb-4">(${idx+1}/${questions.length}) ${q.q}</p>
          <div id="options" class="space-y-2">
            ${q.o.concat(q.a).sort(()=>Math.random()-0.5).map(opt =>
              `<button class="w-full text-left bg-gray-100 p-4 rounded hover:bg-blue-100 option-btn" data-answer="${opt}">${opt}</button>`
            ).join('')}
          </div>
          <div id="feedback" class="mt-4"></div>
          <button id="next" class="hidden mt-4 w-full bg-blue-500 text-white py-3 rounded">Seterusnya</button>
        `;
        document.querySelectorAll('.option-btn').forEach(btn=>{
          btn.onclick = e => {
            const sel = e.target.dataset.answer;
            document.querySelectorAll('.option-btn').forEach(b=>b.disabled=true);
            const correct = sel === q.a;
            if (correct) {
              score++; userData.points+=10; userData.tokens+=1; saveUserData();
              document.getElementById('feedback').innerHTML = `<div class="p-4 bg-green-100 text-green-800 rounded"><b class="font-baloo">Betul!</b> +10 mata<br><small>${q.exp}</small></div>`;
            } else {
              document.getElementById('feedback').innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded"><b class="font-baloo">Kurang tepat.</b> Betul: ${q.a}<br><small>${q.exp}</small></div>`;
            }
            document.getElementById('next').classList.remove('hidden');
          };
        });
        document.getElementById('next').onclick = () => {
          idx++; renderQuestion();
        };
      }

      function finishQuiz() {
        const pct = ((score/questions.length)*100).toFixed(0);
        quizScreen.innerHTML = `
          <h2 class="text-2xl font-baloo mb-2">Kuiz Selesai!</h2>
          <p class="text-xl">Skor anda: ${score}/${questions.length} (${pct}%)</p>
          <button onclick="openLevelSelection('${moduleKey}')" class="mt-6 bg-blue-500 text-white py-3 px-8 rounded">Selesai</button>
        `;
      }

      renderQuestion();
    }

    // --- 10) Hook up module‚Äëcard clicks ---
    document.querySelectorAll('.module-card').forEach(card => {
      card.onclick = () => openLevelSelection(card.id.split('-')[1]);
    });

  </script>
</body>
</html>
